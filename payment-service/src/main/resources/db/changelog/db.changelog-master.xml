<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <changeSet id="1" author="dberezina">
        <comment>Create payments table</comment>
        <createTable tableName="payments">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="order_id" type="BIGINT">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="amount" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="method" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="transaction_id" type="VARCHAR(100)">
                <constraints unique="true"/>
            </column>
            <column name="card_last_four" type="VARCHAR(4)"/>
            <column name="failure_reason" type="VARCHAR(500)"/>
            <column name="processed_at" type="DATETIME2"/>
            <column name="created_at" type="DATETIME2" defaultValueComputed="GETDATE()">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="DATETIME2" defaultValueComputed="GETDATE()">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="2" author="dberezina">
        <comment>Create refunds table</comment>
        <createTable tableName="refunds">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="payment_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="amount" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="reason" type="VARCHAR(500)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="transaction_id" type="VARCHAR(100)"/>
            <column name="requested_by" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="completed_at" type="DATETIME2"/>
            <column name="created_at" type="DATETIME2" defaultValueComputed="GETDATE()">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="DATETIME2" defaultValueComputed="GETDATE()">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="3" author="dberezina">
        <comment>Add foreign key for refunds</comment>
        <addForeignKeyConstraint
                baseTableName="refunds"
                baseColumnNames="payment_id"
                constraintName="fk_refunds_payment"
                referencedTableName="payments"
                referencedColumnNames="id"
                onDelete="CASCADE"/>
    </changeSet>

    <changeSet id="4" author="dberezina">
        <comment>Create indexes</comment>
        <createIndex indexName="idx_payments_order_id" tableName="payments">
            <column name="order_id"/>
        </createIndex>

        <createIndex indexName="idx_payments_user_id" tableName="payments">
            <column name="user_id"/>
        </createIndex>

        <createIndex indexName="idx_payments_status" tableName="payments">
            <column name="status"/>
        </createIndex>

        <createIndex indexName="idx_payments_created_at" tableName="payments">
            <column name="created_at"/>
        </createIndex>

        <createIndex indexName="idx_refunds_payment_id" tableName="refunds">
            <column name="payment_id"/>
        </createIndex>

        <createIndex indexName="idx_refunds_status" tableName="refunds">
            <column name="status"/>
        </createIndex>

        <createIndex indexName="idx_refunds_created_at" tableName="refunds">
            <column name="created_at"/>
        </createIndex>
    </changeSet>

    <changeSet id="5" author="dberezina">
        <comment>Create payment_audit_logs table for compliance</comment>
        <createTable tableName="payment_audit_logs">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="payment_id" type="BIGINT"/>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="action" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="previous_status" type="VARCHAR(20)"/>
            <column name="new_status" type="VARCHAR(20)"/>
            <column name="ip_address" type="VARCHAR(45)"/>
            <column name="user_agent" type="VARCHAR(500)"/>
            <column name="details" type="TEXT"/>
            <column name="success" type="BIT">
                <constraints nullable="false"/>
            </column>
            <column name="error_message" type="VARCHAR(1000)"/>
            <column name="timestamp" type="DATETIME2" defaultValueComputed="GETDATE()">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="6" author="dberezina">
        <comment>Create indexes for audit logs</comment>
        <createIndex indexName="idx_audit_payment_id" tableName="payment_audit_logs">
            <column name="payment_id"/>
        </createIndex>

        <createIndex indexName="idx_audit_action" tableName="payment_audit_logs">
            <column name="action"/>
        </createIndex>

        <!-- NOTE: Separate user_id and timestamp indexes will be replaced with composite -->
    </changeSet>

    <!-- ========================================
         INDEX OPTIMIZATIONS
         ======================================== -->

    <changeSet id="7" author="dberezina">
        <comment>Add composite indexes for fraud detection and audit</comment>
        
        <!-- Query: WHERE user_id = ? AND success = false AND timestamp > ? -->
        <!-- CRITICAL for fraud detection: find failed payment attempts -->
        <createIndex indexName="idx_audit_user_failed_timestamp" tableName="payment_audit_logs">
            <column name="user_id"/>
            <column name="success"/>
            <column name="timestamp" descending="true"/>
        </createIndex>
        
        <!-- Query: WHERE ip_address = ? AND timestamp > ? -->
        <!-- Track multiple attempts from same IP -->
        <createIndex indexName="idx_audit_ip_timestamp" tableName="payment_audit_logs">
            <column name="ip_address"/>
            <column name="timestamp" descending="true"/>
        </createIndex>
        
        <!-- Query: WHERE user_id = ? ORDER BY timestamp DESC -->
        <!-- More efficient than separate indexes -->
        <createIndex indexName="idx_audit_user_timestamp" tableName="payment_audit_logs">
            <column name="user_id"/>
            <column name="timestamp" descending="true"/>
        </createIndex>
        
        <rollback>
            <dropIndex tableName="payment_audit_logs" indexName="idx_audit_user_failed_timestamp"/>
            <dropIndex tableName="payment_audit_logs" indexName="idx_audit_ip_timestamp"/>
            <dropIndex tableName="payment_audit_logs" indexName="idx_audit_user_timestamp"/>
        </rollback>
    </changeSet>

    <!-- ========================================
         DATA INTEGRITY: CHECK CONSTRAINTS
         ======================================== -->

    <changeSet id="8" author="dberezina">
        <comment>Add CHECK constraints for data integrity</comment>
        
        <!-- Payment amounts must be positive -->
        <sql>
            ALTER TABLE payments ADD CONSTRAINT chk_payments_amount 
                CHECK (amount > 0);
        </sql>
        
        <!-- Refund amounts must be positive -->
        <sql>
            ALTER TABLE refunds ADD CONSTRAINT chk_refunds_amount 
                CHECK (amount > 0);
        </sql>
        
        <rollback>
            <sql>ALTER TABLE payments DROP CONSTRAINT chk_payments_amount;</sql>
            <sql>ALTER TABLE refunds DROP CONSTRAINT chk_refunds_amount;</sql>
        </rollback>
    </changeSet>

</databaseChangeLog>
