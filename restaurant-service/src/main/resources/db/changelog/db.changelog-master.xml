<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <changeSet id="1" author="dberezina">
        <comment>Create restaurants table</comment>
        <createTable tableName="restaurants">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(200)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="VARCHAR(1000)"/>
            <column name="owner_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="address" type="VARCHAR(500)">
                <constraints nullable="false"/>
            </column>
            <column name="city" type="VARCHAR(100)"/>
            <column name="postal_code" type="VARCHAR(20)"/>
            <column name="latitude" type="DECIMAL(10,8)">
                <constraints nullable="false"/>
            </column>
            <column name="longitude" type="DECIMAL(11,8)">
                <constraints nullable="false"/>
            </column>
            <column name="phone" type="VARCHAR(20)"/>
            <column name="email" type="VARCHAR(100)"/>
            <column name="cuisine_type" type="VARCHAR(100)"/>
            <column name="average_rating" type="DECIMAL(3,2)"/>
            <column name="total_reviews" type="INT" defaultValue="0"/>
            <column name="is_active" type="BIT" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="opening_time" type="TIME"/>
            <column name="closing_time" type="TIME"/>
            <column name="minimum_order" type="DECIMAL(10,2)"/>
            <column name="delivery_fee" type="DECIMAL(10,2)"/>
            <column name="estimated_delivery_time" type="INT"/>
            <column name="image_url" type="VARCHAR(500)"/>
            <column name="created_at" type="DATETIME2" defaultValueComputed="GETDATE()">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="DATETIME2" defaultValueComputed="GETDATE()">
                <constraints nullable="false"/>
            </column>
            <column name="deleted_at" type="DATETIME2"/>
        </createTable>
    </changeSet>

    <changeSet id="2" author="dberezina">
        <comment>Create menu_items table</comment>
        <createTable tableName="menu_items">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="restaurant_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(200)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="VARCHAR(1000)"/>
            <column name="price" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="category" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="image_url" type="VARCHAR(500)"/>
            <column name="is_available" type="BIT" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="is_vegetarian" type="BIT" defaultValueBoolean="false"/>
            <column name="is_vegan" type="BIT" defaultValueBoolean="false"/>
            <column name="is_gluten_free" type="BIT" defaultValueBoolean="false"/>
            <column name="is_spicy" type="BIT" defaultValueBoolean="false"/>
            <column name="preparation_time" type="INT"/>
            <column name="created_at" type="DATETIME2" defaultValueComputed="GETDATE()">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="DATETIME2" defaultValueComputed="GETDATE()">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
                baseTableName="menu_items"
                baseColumnNames="restaurant_id"
                constraintName="fk_menu_items_restaurant"
                referencedTableName="restaurants"
                referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="3" author="dberezina">
        <comment>Create reviews table</comment>
        <createTable tableName="reviews">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="restaurant_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="order_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="rating" type="DECIMAL(2,1)">
                <constraints nullable="false"/>
            </column>
            <column name="comment" type="VARCHAR(2000)"/>
            <column name="created_at" type="DATETIME2" defaultValueComputed="GETDATE()">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="DATETIME2" defaultValueComputed="GETDATE()">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
                baseTableName="reviews"
                baseColumnNames="restaurant_id"
                constraintName="fk_reviews_restaurant"
                referencedTableName="restaurants"
                referencedColumnNames="id"/>
        
        <addUniqueConstraint
                tableName="reviews"
                columnNames="user_id, order_id"
                constraintName="uk_reviews_user_order"/>
    </changeSet>

    <changeSet id="4" author="dberezina">
        <comment>Create indexes</comment>
        
        <createIndex indexName="idx_restaurants_owner_id" tableName="restaurants">
            <column name="owner_id"/>
        </createIndex>
        
        <createIndex indexName="idx_restaurants_cuisine_type" tableName="restaurants">
            <column name="cuisine_type"/>
        </createIndex>
        
        <createIndex indexName="idx_restaurants_is_active" tableName="restaurants">
            <column name="is_active"/>
        </createIndex>
        
        <createIndex indexName="idx_restaurants_deleted_at" tableName="restaurants">
            <column name="deleted_at"/>
        </createIndex>
        
        <createIndex indexName="idx_restaurants_lat_lon" tableName="restaurants">
            <column name="latitude"/>
            <column name="longitude"/>
        </createIndex>
        
        <createIndex indexName="idx_menu_items_restaurant_id" tableName="menu_items">
            <column name="restaurant_id"/>
        </createIndex>
        
        <createIndex indexName="idx_menu_items_category" tableName="menu_items">
            <column name="category"/>
        </createIndex>

        <createIndex indexName="idx_reviews_restaurant_id" tableName="reviews">
            <column name="restaurant_id"/>
        </createIndex>
        
        <createIndex indexName="idx_reviews_user_id" tableName="reviews">
            <column name="user_id"/>
        </createIndex>
        
        <createIndex indexName="idx_reviews_created_at" tableName="reviews">
            <column name="created_at"/>
        </createIndex>
    </changeSet>

    <!-- ========================================
         INDEX OPTIMIZATIONS
         ======================================== -->

    <changeSet id="5" author="dberezina">
        <comment>Add composite indexes for query optimization</comment>

        <createIndex indexName="idx_restaurants_active" tableName="restaurants">
            <column name="deleted_at"/>
            <column name="is_active"/>
        </createIndex>
        
        <createIndex indexName="idx_restaurants_active_cuisine" tableName="restaurants">
            <column name="deleted_at"/>
            <column name="is_active"/>
            <column name="cuisine_type"/>
        </createIndex>

        <createIndex indexName="idx_menu_items_restaurant_category" tableName="menu_items">
            <column name="restaurant_id"/>
            <column name="category"/>
        </createIndex>
        
        <rollback>
            <dropIndex tableName="restaurants" indexName="idx_restaurants_active"/>
            <dropIndex tableName="restaurants" indexName="idx_restaurants_active_cuisine"/>
            <dropIndex tableName="menu_items" indexName="idx_menu_items_restaurant_category"/>
        </rollback>
    </changeSet>

    <!-- ========================================
         DATA INTEGRITY: CHECK CONSTRAINTS
         ======================================== -->

    <changeSet id="6" author="dberezina">
        <comment>Add CHECK constraints for data integrity</comment>
        
        <sql>
            ALTER TABLE menu_items ADD CONSTRAINT chk_menu_items_price 
                CHECK (price > 0);
        </sql>
        
        <sql>
            ALTER TABLE reviews ADD CONSTRAINT chk_reviews_rating 
                CHECK (rating >= 1.0 AND rating <= 5.0);
        </sql>
        
        <sql>
            ALTER TABLE restaurants ADD CONSTRAINT chk_restaurants_latitude 
                CHECK (latitude >= -90 AND latitude <= 90);
        </sql>
        
        <sql>
            ALTER TABLE restaurants ADD CONSTRAINT chk_restaurants_longitude 
                CHECK (longitude >= -180 AND longitude <= 180);
        </sql>
        
        <sql>
            ALTER TABLE restaurants ADD CONSTRAINT chk_restaurants_delivery_fee 
                CHECK (delivery_fee IS NULL OR delivery_fee >= 0);
        </sql>
        
        <sql>
            ALTER TABLE restaurants ADD CONSTRAINT chk_restaurants_minimum_order 
                CHECK (minimum_order IS NULL OR minimum_order >= 0);
        </sql>
        
        <rollback>
            <sql>ALTER TABLE menu_items DROP CONSTRAINT chk_menu_items_price;</sql>
            <sql>ALTER TABLE reviews DROP CONSTRAINT chk_reviews_rating;</sql>
            <sql>ALTER TABLE restaurants DROP CONSTRAINT chk_restaurants_latitude;</sql>
            <sql>ALTER TABLE restaurants DROP CONSTRAINT chk_restaurants_longitude;</sql>
            <sql>ALTER TABLE restaurants DROP CONSTRAINT chk_restaurants_delivery_fee;</sql>
            <sql>ALTER TABLE restaurants DROP CONSTRAINT chk_restaurants_minimum_order;</sql>
        </rollback>
    </changeSet>

</databaseChangeLog>
